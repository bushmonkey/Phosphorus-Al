<html>
  <head>
    <title>Phosphorus Al!</title>
    <script type="text/javascript">
      function Atom()
      {
        this.neighbours = [];
        this.neutrons = 0;
        this.owner = " ";
        this.coldOwner = " ";

        this.addNeutron = function(player)
        { 
          if (this.owner != " " && this.owner != player) return false;
          
          this.owner = player;
          this.neutrons += 1;
    
          return true;
        };
        
        this.readyToPop = function()
        {
          return this.neutrons >= this.neighbours.count;
        };
        
        this.pop = function()
        {
          if (!readyToPop) return;
          
          this.coldOwner = this.owner;
          this.neutrons = this.neutrons - this.neighbours.count;
          for (neighbour in neighbours)
          {
             neighbour.owner = this.owner;
             neighbour.addNeutron(this.owner);
          }
          if (this.neutrons == 0)
          {
            this.owner = " ";
          }
        };
        
        this.clearColdOwner = function()
        {
          this.coldOwner = " ";
        };
      }
   
      function Grid2d(width, height)
      {
        this.width = width;
        this.height = height;
        this.grid = new Array(width * height);
        for (i=0;i<this.grid.length;i++)
        {
          this.grid[i] = new Atom();
        }
        
        this.item = function(x, y)
        {
          if (x >= this.width || y >= this.height | x < 0 || y < 0)
          {
            return;
          }
          
          return this.grid[x + y * width];
        };

        for (x=0;x<width;x++)
        {
          for (y=0;y<height;y++)
          {
            if (x + 1 < width - 1)
            {
              this.item(x, y).neighbours.push(this.item(x + 1, y));
              this.item(x + 1, y).neighbours.push(this.item(x, y));
            }

            if (y + 1 < height - 1)
            {
              this.item(x, y).neighbours.push(this.item(x, y + 1));
              this.item(x, y + 1).neighbours.push(this.item(x, y));
            }
          }
        }
        
        this.summariseOwners = function()
        {
          summary = {};
          for(i in this.grid)
          {
            item = this.grid[i];
            if (item.owner in summary)
            {
              summary[item.owner] ++;
            }
            else
            {
              summary[item.owner] = 1;
            }
          }
          return summary;
        }

        this.summariseColdOwners = function()
        {
          summary = {};
          for(i in this.grid)
          {
            item = this.grid[i];
            if (item.coldOwner in summary)
            {
              summary[item.coldOwner] ++;
            }
            else
            {
              summary[item.coldOwner] = 1;
            }
          }
          return summary;
        }

        this.hasWinner = function()
        {
          if (Object.keys(this.summariseColdOwners()).length == 1 && Object.keys(this.summariseColdOwners())[0] != " ")
          {
            return true;
          }
          
          firstOwner = this.item(0, 0).owner;
          
          won = true;
          for(i in this.grid)
          {
            item = this.grid[i];
            if(item.owner == " " || item.owner != firstOwner)
            {
              won = false;
              break;
            }
          }
          return won;
        };
        
        this.winner = function()
        {
          if (!this.hasWinner()) return;
          if (this.item(0, 0).owner != " ") return this.item(0, 0).owner;
          return Object.keys(this.summariseColdOwners())[0]
        }
        
        this.hasPendingReactions = function()
        {
          ready = false;
          for(i in this.grid)
          {
            item = this.grid[i];
            if(item.readyToPop())
            {
              ready = true;
              break;
            }
          }
          return ready;
        };
  
        this.sweepActiveAtoms = function()
        {
          liveAtoms = [];
          for(i in this.grid)
          {
            item = this.grid[i];
            if(item.readyToPop())
            {
              liveAtoms.push(item);
            }
          }

          for(i in liveAtoms)
          {
            item = liveAtoms[i];
            item.pop();
          }
        };
        
        this.clearColdOwners = function()
        {
          for(i in this.grid)
          {
            item = this.grid[i];
            item.clearColdOwner();
          }
        };
      }

      function showGrid(grid)
      {
        table = '<table border="1">';
        for (y=0;y<grid.height;y++)
        {
          table += '<tr>';
          for (x=0;x<grid.width;x++)
          {
            b = grid.item(x,y);
            table += '<td>';
            table += b.owner + b.neutrons + " of " + b.neighbours.length;
            table += '</td>';
          }
          table += '</tr>';
        }
        table += '</table>';
        return table;
      }
      
      
      function startGame()
      {
        playerOne = document.forms["gameSetup"]["player1"].value;
        playerTwo = document.forms["gameSetup"]["player2"].value;
        width = document.forms["gameSetup"]["width"].value;
        height = document.forms["gameSetup"]["height"].value;
        
        gameMap = new Grid2d(width, height);
        
        playerOnesMove = true;
        
        while(!gameMap.hasWinner())
        {
          gameMap.clearColdOwners();
          document.getElementById("game_area").innerHTML = showGrid(gameMap);
          currentPlayer = playerOnesMove ? playerOne : playerTwo;
          document.getElementById("notification_area").innerHTML = currentPlayer + "'s move!";
          
          // get move
        }
    
      
        

      }
    
      function debug()
      {
        x = new Grid2d(3, 3);
        y = x.hasWinner();
        document.getElementById("notification_area").innerHTML = y;
      }
    
    
    </script>
  </head>
  <body>
    <h1>Phosphorus Al</h1>
    
    <form name="gameSetup">
      <table>
        <tr>
            <td>Player 1:</td>
            <td><input type="text" name="player1" /></td>
        </tr>
        <tr>
            <td>Player 2:</td>
            <td><input type="text" name="player2" /></td>
        </tr>
        <tr>
            <td>Width:</td>
            <td><input type="text" name="width" /></td>
        </tr>
        <tr>
            <td>Height:</td>
            <td><input type="text" name="height" /></td>
        </tr>
      </table>
      <input type="button" value="Start!" onclick="startGame()" />
    </form> 

    <p id="notification_area">Fill in the details above and click start!</p>
    <p id="game_area">Then the fun and games will begin :o)</p>

  </body>
</html>